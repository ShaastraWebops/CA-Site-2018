{"version":3,"sources":["api/user/user.controller.js"],"names":["index","list","exp","create","show","submit","destroy","changePassword","me","authCallback","json2csv","require","validationError","res","statusCode","err","status","json","handleError","send","req","find","exec","then","users","catch","submitted","fields","csv","data","setHeader","set","newUser","body","provider","role","save","user","token","sign","_id","secrets","session","expiresIn","next","userId","params","id","findById","end","profile","phonenumber","wnumber","previous","prevyear","social","fblink","college","name","address","city","state","education","degree","branch","year","postal","pin","questions","why","right","past","success","findByIdAndRemove","oldPass","String","oldPassword","newPass","newPassword","authenticate","password","findOne","redirect"],"mappings":"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","file":"user.controller.js","sourcesContent":["'use strict';\n\nimport User from './user.model';\nimport config from '../../config/environment';\nimport jwt from 'jsonwebtoken';\nvar json2csv = require('json2csv');\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    return res.status(statusCode).json(err);\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    return res.status(statusCode).send(err);\n  };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexport function index(req, res) {\n  return User.find({}, '-salt -password').exec()\n    .then(users => {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n}\n\nexport function list(req, res) {\n  return User.find({submitted: true}, '-_id -salt -password -provider -role').exec()\n    .then(users => {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n}\n\nexport function exp(req, res) {\n  return User.find({submitted: true}, '-_id -salt -password -provider -role').exec()\n    .then(users => {\n      var fields = ['name', 'email', 'college.address', 'college.city', 'college.name', 'college.state',\n      'education.branch', 'education.degree', 'education.year', 'phonenumber', 'previous', 'prevyear',\n      'postal.address', 'postal.city', 'postal.pin', 'postal.state', 'questions.past', 'questions.right',\n      'questions.why', 'social', 'wnumber', 'fblink'];\n      var csv = json2csv({ data: users, fields: fields});\n      res.setHeader('Content-disposition', 'attachment; filename=users.csv');\n      res.set('Content-Type', 'text/csv');\n      res.status(200).send(csv);\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Creates a new user\n */\nexport function create(req, res) {\n  var newUser = new User(req.body);\n  newUser.provider = 'local';\n  newUser.role = 'user';\n  newUser.save()\n    .then(function(user) {\n      var token = jwt.sign({ _id: user._id }, config.secrets.session, {\n        expiresIn: 60 * 60 * 5\n      });\n      res.json({ token });\n    })\n    .catch(validationError(res));\n}\n\n/**\n * Get a single user\n */\nexport function show(req, res, next) {\n  var userId = req.params.id;\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if(!user) {\n        return res.status(404).end();\n      }\n      res.json(user.profile);\n    })\n    .catch(err => next(err));\n}\n\nexport function submit(req, res) {\n  return User.findById(req.user._id).exec()\n    .then(user => {\n      user.phonenumber = req.body.phonenumber;\n      user.wnumber = req.body.wnumber;\n      user.previous = req.body.previous;\n      user.prevyear = req.body.prevyear;\n      user.social = req.body.social;\n      user.fblink = req.body.fblink;\n      user.college.name = req.body.college.name;\n      user.college.address = req.body.college.address;\n      user.college.city = req.body.college.city;\n      user.college.state = req.body.college.state;\n      user.education.degree = req.body.education.degree;\n      user.education.branch = req.body.education.branch;\n      user.education.year = req.body.education.year;\n      user.postal.address = req.body.postal.address;\n      user.postal.city = req.body.postal.city;\n      user.postal.state = req.body.postal.state;\n      user.postal.pin = req.body.postal.pin;\n      user.questions.why = req.body.questions.why;\n      user.questions.right = req.body.questions.right;\n      user.questions.past = req.body.questions.past;\n      user.submitted = true;\n      return user.save()\n        .then(() => {\n          res.json({success: true});\n        })\n        .catch(handleError(res));\n    });\n}\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexport function destroy(req, res) {\n  return User.findByIdAndRemove(req.params.id).exec()\n    .then(function() {\n      res.status(204).end();\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Change a users password\n */\nexport function changePassword(req, res) {\n  var userId = req.user._id;\n  var oldPass = String(req.body.oldPassword);\n  var newPass = String(req.body.newPassword);\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if(user.authenticate(oldPass)) {\n        user.password = newPass;\n        return user.save()\n          .then(() => {\n            res.status(204).end();\n          })\n          .catch(validationError(res));\n      } else {\n        return res.status(403).end();\n      }\n    });\n}\n\n/**\n * Get my info\n */\nexport function me(req, res, next) {\n  var userId = req.user._id;\n\n  return User.findOne({ _id: userId }, '-salt -password').exec()\n    .then(user => { // don't ever give out the password or salt\n      if(!user) {\n        return res.status(401).end();\n      }\n      res.json(user);\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Authentication callback\n */\nexport function authCallback(req, res) {\n  res.redirect('/');\n}\n"]}