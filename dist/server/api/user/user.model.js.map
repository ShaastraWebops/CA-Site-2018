{"version":3,"sources":["api/user/user.model.js"],"names":["Promise","require","authTypes","UserSchema","name","String","email","type","lowercase","required","indexOf","provider","submitted","Boolean","default","selected","Number","role","password","dob","month","day","year","fbdob","files","taskid","salt","phonenumber","wnumber","college","address","city","state","education","degree","branch","postal","pin","previous","prevyear","social","fblink","questions","why","right","past","virtual","get","_id","path","validate","length","value","constructor","findOne","exec","then","user","id","catch","err","validatePresenceOf","pre","next","isModified","Error","makeSalt","saltErr","encryptPassword","encryptErr","hashedPassword","methods","authenticate","callback","pwdGen","byteSize","defaultByteSize","randomBytes","toString","defaultIterations","defaultKeyLength","Buffer","pbkdf2Sync","pbkdf2","key","model"],"mappings":"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","file":"user.model.js","sourcesContent":["'use strict';\n/*eslint no-invalid-this:0*/\nimport crypto from 'crypto';\nmongoose.Promise = require('bluebird');\nimport mongoose, {Schema} from 'mongoose';\nimport {registerEvents} from './user.events';\n\nconst authTypes = ['github', 'twitter', 'facebook', 'google'];\n\nvar UserSchema = new Schema({\n  name: String,\n  email: {\n    type: String,\n    lowercase: true,\n    required() {\n      if(authTypes.indexOf(this.provider) === -1) {\n        return true;\n      } else {\n        return false;\n      }\n    }\n  },\n  submitted: {type: Boolean, default: false},\n  selected: {type: Number, default: 0},   //0 means decided, 1 means approvedand 2 means rejected\n  role: {\n    type: String,\n    default: 'user'\n  },\n  password: {\n    type: String,\n    required() {\n      if(authTypes.indexOf(this.provider) === -1) {\n        return true;\n      } else {\n        return false;\n      }\n    }\n  },\n  dob: {\n    month: String,\n    day: Number,\n    year: Number\n  },\n  fbdob: {\n    type: String\n  },\n  files: [{\n    taskid: String,\n    name: String\n  }],\n  provider: String,\n  salt: String,\n  phonenumber: Number,\n  wnumber: Number,\n  college: {\n    name: String,\n    address: String,\n    city: String,\n    state: String\n  },\n  education: {\n    degree: String,\n    branch: String,\n    year: String\n  },\n  postal: {\n    address: String,\n    city: String,\n    state: String,\n    pin: String\n  },\n  previous: Boolean,  //whether he had been a CA in a previous year\n  prevyear: {type: String, default: null},\n  social: String,\n  fblink: String,\n  questions: {\n    why: String,\n    right: String,\n    past: String\n  },\n  selected: {\n    type: Number,\n    default: 0\n  },\n  points: {type: Number, default: 0},\n  facebook: {},\n  github: {}\n});\n\n/**\n * Virtuals\n */\n\n// Public profile information\nUserSchema\n  .virtual('profile')\n  .get(function() {\n    return {\n      name: this.name,\n      role: this.role\n    };\n  });\n\n// Non-sensitive info we'll be putting in the token\nUserSchema\n  .virtual('token')\n  .get(function() {\n    return {\n      _id: this._id,\n      role: this.role\n    };\n  });\n\n/**\n * Validations\n */\n\n// Validate empty email\nUserSchema\n  .path('email')\n  .validate(function(email) {\n    if(authTypes.indexOf(this.provider) !== -1) {\n      return true;\n    }\n    return email.length;\n  }, 'Email cannot be blank');\n\n// Validate empty password\nUserSchema\n  .path('password')\n  .validate(function(password) {\n    if(authTypes.indexOf(this.provider) !== -1) {\n      return true;\n    }\n    return password.length;\n  }, 'Password cannot be blank');\n\n// Validate email is not taken\nUserSchema\n  .path('email')\n  .validate(function(value) {\n    if(authTypes.indexOf(this.provider) !== -1) {\n      return true;\n    }\n\n    return this.constructor.findOne({ email: value }).exec()\n      .then(user => {\n        if(user) {\n          if(this.id === user.id) {\n            return true;\n          }\n          return false;\n        }\n        return true;\n      })\n      .catch(function(err) {\n        throw err;\n      });\n  }, 'The specified email address is already in use.');\n\nvar validatePresenceOf = function(value) {\n  return value && value.length;\n};\n\n/**\n * Pre-save hook\n */\nUserSchema\n  .pre('save', function(next) {\n    // Handle new/update passwords\n    if(!this.isModified('password')) {\n      return next();\n    }\n\n    if(!validatePresenceOf(this.password)) {\n      if(authTypes.indexOf(this.provider) === -1) {\n        return next(new Error('Invalid password'));\n      } else {\n        return next();\n      }\n    }\n\n    // Make salt with a callback\n    this.makeSalt((saltErr, salt) => {\n      if(saltErr) {\n        return next(saltErr);\n      }\n      this.salt = salt;\n      this.encryptPassword(this.password, (encryptErr, hashedPassword) => {\n        if(encryptErr) {\n          return next(encryptErr);\n        }\n        this.password = hashedPassword;\n        return next();\n      });\n    });\n  });\n\n/**\n * Methods\n */\nUserSchema.methods = {\n  /**\n   * Authenticate - check if the passwords are the same\n   *\n   * @param {String} password\n   * @param {Function} callback\n   * @return {Boolean}\n   * @api public\n   */\n  authenticate(password, callback) {\n    if(!callback) {\n      return this.password === this.encryptPassword(password);\n    }\n\n    this.encryptPassword(password, (err, pwdGen) => {\n      if(err) {\n        return callback(err);\n      }\n\n      if(this.password === pwdGen) {\n        return callback(null, true);\n      } else {\n        return callback(null, false);\n      }\n    });\n  },\n\n  /**\n   * Make salt\n   *\n   * @param {Number} [byteSize] - Optional salt byte size, default to 16\n   * @param {Function} callback\n   * @return {String}\n   * @api public\n   */\n  makeSalt(...args) {\n    let byteSize;\n    let callback;\n    let defaultByteSize = 16;\n\n    if(typeof args[0] === 'function') {\n      callback = args[0];\n      byteSize = defaultByteSize;\n    } else if(typeof args[1] === 'function') {\n      callback = args[1];\n    } else {\n      throw new Error('Missing Callback');\n    }\n\n    if(!byteSize) {\n      byteSize = defaultByteSize;\n    }\n\n    return crypto.randomBytes(byteSize, (err, salt) => {\n      if(err) {\n        return callback(err);\n      } else {\n        return callback(null, salt.toString('base64'));\n      }\n    });\n  },\n\n  /**\n   * Encrypt password\n   *\n   * @param {String} password\n   * @param {Function} callback\n   * @return {String}\n   * @api public\n   */\n  encryptPassword(password, callback) {\n    if(!password || !this.salt) {\n      if(!callback) {\n        return null;\n      } else {\n        return callback('Missing password or salt');\n      }\n    }\n\n    var defaultIterations = 10000;\n    var defaultKeyLength = 64;\n    var salt = new Buffer(this.salt, 'base64');\n\n    if(!callback) {\n      // eslint-disable-next-line no-sync\n      return crypto.pbkdf2Sync(password, salt, defaultIterations,\n          defaultKeyLength, 'sha1')\n        .toString('base64');\n    }\n\n    return crypto.pbkdf2(password, salt, defaultIterations, defaultKeyLength,\n      'sha1', (err, key) => {\n        if(err) {\n          return callback(err);\n        } else {\n          return callback(null, key.toString('base64'));\n        }\n      });\n  }\n};\n\nregisterEvents(UserSchema);\nexport default mongoose.model('User', UserSchema);\n"]}