{"version":3,"sources":["api/task/task.controller.js"],"names":["create","apply","getusers","show","gettasks","reject","approve","validationError","res","statusCode","err","status","json","handleError","send","req","newTask","body","save","then","success","message","catch","userid","user","_id","taskid","params","id","error","findById","exec","task","update","$addToSet","pending","msg","nModified","find","users","taskId","populate","tasks","rejected","$pull","Types","ObjectId","points","approved","$inc"],"mappings":"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","file":"task.controller.js","sourcesContent":["'use strict';\n\nimport Task from './task.model';\nimport User from '../user/user.model';\nimport mongoose from 'mongoose';\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    return res.status(statusCode).json(err);\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    return res.status(statusCode).send(err);\n  };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\n\n/**\n * Creates a new user\n */\nexport function create(req, res) {\n  var newTask = new Task(req.body);\n  newTask.save()\n    .then(function() {\n      res.json({success: true, message: 'New Task Created'});\n    })\n    .catch(validationError(res));\n}\n\nexport function apply(req, res) {\n    var userid = req.user._id;\n    var taskid = req.params.id;\n    var error = false;\n    return Task.findById(taskid).exec()\n      .then(task => {\n        if(!task) {\n        return res.json({success: false, message : \"No such task available\"});\n        }\n        Task.update({_id:taskid},{$addToSet:{pending: userid}}, function(err,msg){\n        if(err) throw err;\n        if(msg.nModified == 0) //1 in console\n          {\n            res.json({success: false, message: 'Already applied'});\n          }\n          else {\n            res.json({success: true, message: 'Applied'});\n          }\n       });\n\n    });\n}\n\nexport function getusers(req, res) {\n\n  var id = req.params.id;\n  User.find({'files.taskid': id}).exec()\n  .then(users => {\n    if(!users){\n      res.json({success: false, message: \"Users no longer exists\"});\n    }\n    else {\n      res.json({success: true, users: users});\n    }\n  })\n  .catch(handleError(res));\n}\n\nexport function show(req, res) {\n  var taskId = req.params.id;\n\n  return Task.findById(taskId).exec()\n    .then(task => {\n      if(!task) {\n        return res.status(404);\n      }\n      res.json({success: true, task: task});\n    })\n    .catch(handleError(res));\n}\n\nexport function gettasks(req, res) {\n\n  var userid = req.user._id;\n  Task.find({}).\n  populate('approved').exec()\n  .then(tasks => {\n    res.status(200).json({tasks: tasks, userid: userid});\n  })\n  .catch(handleError(res));\n}\n\nexport function reject(req, res) {\n  \n  var taskId = req.params.id;\n  var userid = req.body.userid;\n\n  Task.findById(taskId).exec()\n  .then(task => {\n    if (!task) {\n      return res.json({success: false, msg: 'no such task exists!'});\n    }\n    Task.update({_id: taskId}, {$addToSet: {rejected: userid}}, function(err, msg) {\n      if (err) throw err;\n      if  (msg.nModified == 0){\n        res.json({success: false, msg: 'Already rejected!'});\n      }\n      else {\n        Task.update({'_id': taskId}, {$pull: {'approved': mongoose.Types.ObjectId(userid)}}, function(err, msg) {\n          if (err) throw err;\n          res.json({success: true, msg: \"Rejected!\"});\n        });\n      }\n    });\n  });  \n}\n\nexport function approve(req, res) {\n\n  var taskId = req.params.id;\n  var userid = req.body.userid;\n\n  Task.findById(taskId).exec()\n  .then(task => {\n    if(!task) {\n\n      return res.json({success: false, msg: \"no such task exists!\"});\n    }\n    var points = task.points;\n    Task.update({_id: taskId}, {$addToSet:{approved: userid}}, function(err, msg){\n\n      if (err) throw err;\n      if(msg.nModified == 0) {\n\n        res.json({success: false, msg: 'Already approved!'});\n      }\n      else {\n        User.update({_id: userid}, {$inc: {points: points}}, function(err, msg) {\n\n          if (err) throw err;\n        });\n        Task.update({'_id': taskId}, {$pull: {'rejected': mongoose.Types.ObjectId(userid)}}, function(err, msg) {\n          if (err) throw err;\n          res.json({success: true, msg: \"Approved!\"});\n        });\n      }\n    });\n  });\n}"]}